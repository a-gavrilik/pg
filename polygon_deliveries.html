<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Delivery polygon</title>

<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>

<style>
html, body, #map {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
</style>
</head>

<body>
<div id="map"></div>

<script>
// -------------------------------
// Универсальный парсер URL-параметров
// -------------------------------
function getJsonParam(name) {
  const raw = new URLSearchParams(window.location.search).get(name);
  if (!raw) return null;

  try {
    return JSON.parse(decodeURIComponent(raw));
  } catch (e) {
    console.error(`Ошибка парсинга параметра ${name}`, e);
    return null;
  }
}

ymaps.ready(function () {

  // -------------------------------
  // Чтение параметров
  // -------------------------------
  const polygonCoords = getJsonParam("coords");   // [[lat,lon],...]
  const deliveryPoints = getJsonParam("points"); // [[lat,lon],...]

  // -------------------------------
  // Создание карты
  // -------------------------------
  const map = new ymaps.Map("map", {
    center: [55.75, 37.61], // fallback
    zoom: 9,
    controls: ["zoomControl"]
  });

  let boundsObjects = [];

  // -------------------------------
  // Рисуем полигон
  // -------------------------------
  if (polygonCoords && polygonCoords.length > 0) {
    const polygon = new ymaps.Polygon(
      [polygonCoords], // ВАЖНО: массив контуров
      {},
      {
        fillColor: "#00FF0055",
        strokeColor: "#007700",
        strokeWidth: 2,
        strokeOpacity: 0.9
      }
    );

    map.geoObjects.add(polygon);
    boundsObjects.push(polygon);
  }

  // -------------------------------
  // Рисуем точки доставок
  // -------------------------------
  if (deliveryPoints && deliveryPoints.length > 0) {

    const pointsCollection = new ymaps.GeoObjectCollection(null, {
      preset: "islands#redDotIcon",
      draggable: false
    });

    deliveryPoints.forEach(p => {
      if (!Array.isArray(p) || p.length !== 2) return;

      const placemark = new ymaps.Placemark(
        p,
        {},
        {
          preset: "islands#redDotIcon",
          iconColor: "#d0021b"
        }
      );

      pointsCollection.add(placemark);
    });

    map.geoObjects.add(pointsCollection);
    boundsObjects.push(pointsCollection);
  }

  // -------------------------------
  // Масштабируем карту по объектам
  // -------------------------------
  if (boundsObjects.length > 0) {
    const bounds = ymaps.geoQuery(boundsObjects).getBounds();
    if (bounds) {
      map.setBounds(bounds, {
        checkZoomRange: true,
        zoomMargin: 30
      });
    }
  }

});
</script>

</body>
</html>