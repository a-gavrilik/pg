<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Several Polygons</title>
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>

<style>
html, body, #map {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
</style>
</head>

<body>
<div id="map"></div>

<script>
function mergeBounds(b1, b2) {
  // bounds format: [[minLat, minLon], [maxLat, maxLon]]
  if (!b1) return b2;
  if (!b2) return b1;

  const minLat = Math.min(b1[0][0], b2[0][0]);
  const minLon = Math.min(b1[0][1], b2[0][1]);
  const maxLat = Math.max(b1[1][0], b2[1][0]);
  const maxLon = Math.max(b1[1][1], b2[1][1]);

  return [[minLat, minLon], [maxLat, maxLon]];
}

ymaps.ready(function () {
  const map = new ymaps.Map("map", {
    center: [55.75, 37.61],
    zoom: 9
  });

  const params = new URLSearchParams(window.location.search);
  const polygonsRaw = params.get("polygons");

  if (!polygonsRaw) {
    console.warn("No polygons provided");
    return;
  }

  let polygons;
  try {
    // URLSearchParams.get() уже декодирует строку
    polygons = JSON.parse(polygonsRaw);
  } catch (e) {
    console.error("Polygons parse error:", e);
    console.error("Raw:", polygonsRaw);
    return;
  }

  if (!Array.isArray(polygons)) {
    console.error("Polygons is not an array");
    return;
  }

  let allBounds = null;
  let rendered = 0;

  polygons.forEach((ring, idx) => {
    if (!Array.isArray(ring) || ring.length < 4) {
      console.warn("Skip invalid ring at index", idx, ring);
      return;
    }

    // ВАЖНО: Polygon ждёт 3D-массив контуров: [outerRing, innerRing...]
    // У нас ring = outerRing, поэтому передаём [ring]
    const polygon = new ymaps.Polygon(
      [ring],
      {},
      {
        fillColor: "#474A5155",
        strokeColor: "#474A51",
        strokeWidth: 2,
        opacity: 0.6
      }
    );

    // Иногда помогает для "касающихся/почти пересекающихся" контуров:
    // polygon.geometry.setFillRule("nonZero");

    map.geoObjects.add(polygon);
    rendered++;

    // Считаем bounds устойчиво (бывает null у отдельных полигонов)
    const b = polygon.geometry.getBounds();
    if (b) {
      allBounds = mergeBounds(allBounds, b);
    } else {
      console.warn("Bounds is null for polygon index", idx);
    }
  });

  if (rendered === 0) {
    console.warn("No valid polygons to render");
    return;
  }

  if (allBounds) {
    map.setBounds(allBounds, { checkZoomRange: true, zoomMargin: 20 });
  } else {
    console.warn("Could not compute bounds, keeping default view");
  }
});
</script>

</body>
</html>
