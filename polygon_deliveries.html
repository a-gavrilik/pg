<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Delivery polygon with brands</title>

<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>

<style>
html, body, #map {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
</style>
</head>

<body>
<div id="map"></div>

<script>
// ----------------------------------------
// Универсальный JSON-парсер из URL
// ----------------------------------------
function getJsonParam(name) {
  const raw = new URLSearchParams(window.location.search).get(name);
  if (!raw) return null;

  try {
    return JSON.parse(decodeURIComponent(raw));
  } catch (e) {
    console.error("Ошибка парсинга параметра:", name, e);
    return null;
  }
}

// ----------------------------------------
// Цвета брендов (можно расширять)
// ----------------------------------------
const BRAND_COLORS = {
  "LK": "#E6E6E6",
  "MF": "#FF8800",
  "PF": "#9ACD32"
};

// fallback-цвет
const DEFAULT_COLOR = "#888888";

ymaps.ready(function () {

  // ----------------------------------------
  // Читаем параметры
  // ----------------------------------------
  const polygonCoords = getJsonParam("coords");   // [[lat,lon],...]
  const deliveryPoints = getJsonParam("points"); // [[lat,lon,"Brand"],...]

  // ----------------------------------------
  // Инициализация карты
  // ----------------------------------------
  const map = new ymaps.Map("map", {
    center: [55.75, 37.61],
    zoom: 9,
    controls: ["zoomControl"]
  });

  let boundsObjects = [];

  // ----------------------------------------
  // Полигон
  // ----------------------------------------
  if (polygonCoords && polygonCoords.length > 0) {
    const polygon = new ymaps.Polygon(
      [polygonCoords],
      {},
      {
        fillColor: "#00FF0055",
        strokeColor: "#007700",
        strokeWidth: 2,
        strokeOpacity: 0.9
      }
    );

    map.geoObjects.add(polygon);
    boundsObjects.push(polygon);
  }

  // ----------------------------------------
  // Точки доставок (по брендам)
  // ----------------------------------------
  if (deliveryPoints && deliveryPoints.length > 0) {

    const pointsCollection = new ymaps.GeoObjectCollection();

    deliveryPoints.forEach(p => {
      if (!Array.isArray(p) || p.length < 2) return;

      const lat = p[0];
      const lon = p[1];
      const brand = p[2] || "Unknown";

      const color = BRAND_COLORS[brand] || DEFAULT_COLOR;

      const placemark = new ymaps.Placemark(
        [lat, lon],
        {
          hintContent: brand,
          balloonContent:
            "<b>Бренд:</b> " + brand +
            "<br><b>Координаты:</b> " +
            lat.toFixed(5) + ", " + lon.toFixed(5)
        },
        {
          preset: "islands#circleDotIcon",
          iconColor: color,
          iconCircleRadius: 4
        }
      );

      pointsCollection.add(placemark);
    });

    map.geoObjects.add(pointsCollection);
    boundsObjects.push(pointsCollection);
  }

  // ----------------------------------------
  // Масштабирование карты
  // ----------------------------------------
  if (boundsObjects.length > 0) {
    const bounds = ymaps.geoQuery(boundsObjects).getBounds();
    if (bounds) {
      map.setBounds(bounds, {
        checkZoomRange: true,
        zoomMargin: 30
      });
    }
  }

});
</script>

</body>
</html>
